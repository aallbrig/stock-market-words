name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.123.7'
        extended: true
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: python3/requirements.txt
    
    - name: Install Python dependencies
      run: |
        cd python3
        pip install -r requirements.txt
    
    - name: Generate Hugo data files
      run: |
        cd python3
        # Generate strategy filter data and pages
        python -m stock_ticker.cli hugo strategies || echo "No existing data, skipping strategy generation"
        python -m stock_ticker.cli hugo pages || echo "Page generation failed, using existing pages"
        cd ..
        
    - name: Run E2E tests with managed server
      run: npm run test:e2e:ci
      env:
        START_SERVER: 'true'
        SERVER_PORT: '8668'
        SERVER_HOST: '127.0.0.1'
      
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: test-reports/
        retention-days: 30
        
    - name: Test Summary
      if: always()
      run: |
        if [ -f test-reports/junit.xml ]; then
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test reports have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
          echo "View the detailed HTML report in the artifacts section." >> $GITHUB_STEP_SUMMARY
        fi
