name: QA Tests (GitHub Pages)

on:
  # Run after deployment workflow completes
  workflow_run:
    workflows: ["Website QA Deploy"]
    types:
      - completed
  # Allow manual trigger
  workflow_dispatch:

jobs:
  qa-tests:
    name: Test deployed QA site
    runs-on: ubuntu-latest
    # Only run if deployment was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Extract GitHub Pages URL from repository
      id: pages_url
      run: |
        # Extract owner and repo from GITHUB_REPOSITORY (format: owner/repo)
        OWNER=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)
        REPO=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
        
        # Construct GitHub Pages URL
        PAGES_URL="https://${OWNER}.github.io/${REPO}/"
        
        echo "pages_url=${PAGES_URL}" >> $GITHUB_OUTPUT
        echo "Testing against: ${PAGES_URL}"
    
    - name: Wait for deployment to be available
      run: |
        echo "Waiting for site to be available at ${{ steps.pages_url.outputs.pages_url }}"
        
        # Wait up to 5 minutes for the site to be available
        for i in {1..60}; do
          if curl -f -s -o /dev/null "${{ steps.pages_url.outputs.pages_url }}"; then
            echo "‚úì Site is available"
            exit 0
          fi
          echo "Attempt $i/60: Site not ready yet, waiting..."
          sleep 5
        done
        
        echo "ERROR: Site did not become available within 5 minutes"
        exit 1
    
    - name: Run E2E tests against QA site
      run: npm run test:e2e:ci
      env:
        TEST_URL: ${{ steps.pages_url.outputs.pages_url }}
        START_SERVER: 'false'
      timeout-minutes: 10
      
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: qa-test-reports
        path: test-reports/
        retention-days: 30
        
    - name: Test Summary
      if: always()
      run: |
        echo "## QA Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Tested site: ${{ steps.pages_url.outputs.pages_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f test-reports/junit.xml ]; then
          echo "Test reports have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
          echo "View the detailed HTML report in the artifacts section." >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Comment on PR with QA results
      if: github.event.workflow_run.event == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const pagesUrl = '${{ steps.pages_url.outputs.pages_url }}';
          
          let message = '## üß™ QA Tests Completed\n\n';
          message += `Tested against: ${pagesUrl}\n\n`;
          
          if (fs.existsSync('test-reports/junit.xml')) {
            message += '‚úÖ Tests executed successfully. Check artifacts for detailed reports.\n';
          } else {
            message += '‚ùå Test execution failed. Check workflow logs for details.\n';
          }
          
          // Note: This will only work if we can find the PR number
          // For workflow_run triggers, we'd need to extract it from the triggering workflow
          console.log(message);
