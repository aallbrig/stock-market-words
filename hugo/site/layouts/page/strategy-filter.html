{{ define "main" }}
<div class="container mt-5">
  <div class="row">
    <div class="col">
      <h1>{{ .Title }}</h1>
      {{ .Content }}
      
      {{ $strategyKey := .Params.strategy_key }}
      {{ $strategyData := index .Site.Data (printf "strategy_%s" $strategyKey) }}
      
      {{ if $strategyData }}
      
      <!-- Strategy Summary Card -->
      <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">{{ $strategyData.icon }} {{ $strategyData.strategy }} Summary</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h5>Description</h5>
              <p class="lead">{{ $strategyData.description }}</p>
            </div>
            <div class="col-md-6">
              <h5>Filter Criteria</h5>
              <code>{{ $strategyData.filter_criteria }}</code>
              <hr>
              <h3 class="text-center mt-3">
                <span class="badge bg-success">{{ $strategyData.total_matches }} Matching Stocks</span>
              </h3>
            </div>
          </div>
        </div>
        <div class="card-footer text-muted">
          <small>Data generated: {{ $strategyData.generated_at }}</small>
        </div>
      </div>
      
      <!-- Matching Stocks Table -->
      <div class="mb-5">
        <h2>Matching Stocks</h2>
        <p class="text-muted">Stocks that meet the {{ $strategyData.strategy }} criteria. Click column headers to sort.</p>
        
        {{ if gt $strategyData.total_matches 0 }}
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="strategyTable">
            <thead class="table-dark">
              <tr>
                <th>Symbol</th>
                <th>Name</th>
                <th>Sector</th>
                <th>Exchange</th>
                <th>Price</th>
                <th>Volume</th>
                <th>Market Cap</th>
                <th>P/E Ratio</th>
                {{ if eq $strategyKey "dividend_daddy" }}
                <th>Dividend Yield %</th>
                {{ end }}
                {{ if eq $strategyKey "institutional_whale" }}
                <th>Dividend Yield %</th>
                {{ end }}
                {{ if or (eq $strategyKey "moon_shot") (eq $strategyKey "falling_knife") (eq $strategyKey "over_hyped") (eq $strategyKey "institutional_whale") }}
                <th>Beta</th>
                {{ end }}
                {{ if or (eq $strategyKey "moon_shot") (eq $strategyKey "falling_knife") (eq $strategyKey "over_hyped") }}
                <th>RSI (14-Day)</th>
                {{ end }}
                {{ if or (eq $strategyKey "dividend_daddy") (eq $strategyKey "falling_knife") (eq $strategyKey "institutional_whale") }}
                <th>200-Day MA</th>
                {{ end }}
                <th>52W High</th>
                <th>52W Low</th>
                <th>Strategy Score</th>
              </tr>
            </thead>
            <tbody>
              {{ range $strategyData.tickers }}
              <tr>
                <td><strong><a href="https://finance.yahoo.com/quote/{{ .symbol }}" target="_blank" title="{{ .symbol }} - {{ .name }}">{{ .symbol }}</a></strong></td>
                <td>{{ .name }}</td>
                <td>
                  {{ if .sector }}
                    <span class="badge bg-info">{{ .sector }}</span>
                  {{ else }}
                    <span class="text-muted">-</span>
                  {{ end }}
                </td>
                <td><span class="badge bg-secondary">{{ .exchange }}</span></td>
                <td data-order="{{ .price }}">${{ printf "%.2f" .price }}</td>
                <td data-order="{{ .volume }}">{{ .volume | lang.FormatNumber 0 }}</td>
                <td data-order="{{ if .marketCap }}{{ .marketCap }}{{ else }}0{{ end }}">
                  {{ if .marketCap }}
                    ${{ .marketCap | lang.FormatNumber 0 }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                <td data-order="{{ if .peRatio }}{{ .peRatio }}{{ else }}0{{ end }}">
                  {{ if .peRatio }}
                    {{ printf "%.2f" .peRatio }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                {{ if eq $strategyKey "dividend_daddy" }}
                <td data-order="{{ if .dividendYield }}{{ .dividendYield }}{{ else }}0{{ end }}">
                  {{ if .dividendYield }}
                    {{ printf "%.2f%%" .dividendYield }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                {{ end }}
                {{ if eq $strategyKey "institutional_whale" }}
                <td data-order="{{ if .dividendYield }}{{ .dividendYield }}{{ else }}0{{ end }}">
                  {{ if .dividendYield }}
                    {{ printf "%.2f%%" .dividendYield }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                {{ end }}
                {{ if or (eq $strategyKey "moon_shot") (eq $strategyKey "falling_knife") (eq $strategyKey "over_hyped") (eq $strategyKey "institutional_whale") }}
                <td data-order="{{ if .beta }}{{ .beta }}{{ else }}0{{ end }}">
                  {{ if .beta }}
                    {{ printf "%.2f" .beta }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                {{ end }}
                {{ if or (eq $strategyKey "moon_shot") (eq $strategyKey "falling_knife") (eq $strategyKey "over_hyped") }}
                <td data-order="{{ if .rsi }}{{ .rsi }}{{ else }}0{{ end }}">
                  {{ if .rsi }}
                    {{ $rsi := .rsi }}
                    {{ if lt $rsi 30.0 }}
                      <span class="badge bg-success">{{ printf "%.1f" $rsi }}</span>
                    {{ else if gt $rsi 70.0 }}
                      <span class="badge bg-danger">{{ printf "%.1f" $rsi }}</span>
                    {{ else }}
                      <span class="badge bg-secondary">{{ printf "%.1f" $rsi }}</span>
                    {{ end }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                {{ end }}
                {{ if or (eq $strategyKey "dividend_daddy") (eq $strategyKey "falling_knife") (eq $strategyKey "institutional_whale") }}
                <td data-order="{{ if .ma200 }}{{ .ma200 }}{{ else }}0{{ end }}">
                  {{ if .ma200 }}
                    ${{ printf "%.2f" .ma200 }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                {{ end }}
                <td data-order="{{ if .scores }}{{ if eq $strategyKey "dividend_daddy" }}{{ .scores.dividendDaddy }}{{ else if eq $strategyKey "moon_shot" }}{{ .scores.moonShot }}{{ else if eq $strategyKey "falling_knife" }}{{ .scores.fallingKnife }}{{ else if eq $strategyKey "over_hyped" }}{{ .scores.overHyped }}{{ else if eq $strategyKey "institutional_whale" }}{{ .scores.instWhale }}{{ end }}{{ else }}0{{ end }}">
                  {{ if .scores }}
                    {{ $score := 0 }}
                    {{ if eq $strategyKey "dividend_daddy" }}
                      {{ $score = .scores.dividendDaddy }}
                    {{ else if eq $strategyKey "moon_shot" }}
                      {{ $score = .scores.moonShot }}
                    {{ else if eq $strategyKey "falling_knife" }}
                      {{ $score = .scores.fallingKnife }}
                    {{ else if eq $strategyKey "over_hyped" }}
                      {{ $score = .scores.overHyped }}
                    {{ else if eq $strategyKey "institutional_whale" }}
                      {{ $score = .scores.instWhale }}
                    {{ end }}
                    
                    {{ if $score }}
                      {{ if ge $score 80 }}
                        <span class="badge bg-success fs-6">{{ $score }}</span>
                      {{ else if ge $score 60 }}
                        <span class="badge bg-info fs-6">{{ $score }}</span>
                      {{ else if ge $score 40 }}
                        <span class="badge bg-warning fs-6">{{ $score }}</span>
                      {{ else }}
                        <span class="badge bg-secondary fs-6">{{ $score }}</span>
                      {{ end }}
                    {{ else }}
                      <span class="text-muted">N/A</span>
                    {{ end }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                <td data-order="{{ if .week52High }}{{ .week52High }}{{ else }}0{{ end }}">
                  {{ if .week52High }}
                    ${{ printf "%.2f" .week52High }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
                <td data-order="{{ if .week52Low }}{{ .week52Low }}{{ else }}0{{ end }}">
                  {{ if .week52Low }}
                    ${{ printf "%.2f" .week52Low }}
                  {{ else }}
                    <span class="text-muted">N/A</span>
                  {{ end }}
                </td>
              </tr>
              {{ end }}
            </tbody>
          </table>
        </div>
        {{ else }}
        <div class="alert alert-info" role="alert">
          <h4 class="alert-heading">No Matching Stocks</h4>
          <p>No stocks currently match the {{ $strategyData.strategy }} criteria. This could mean:</p>
          <ul>
            <li>Market conditions don't favor this strategy right now</li>
            <li>The filtering criteria are very strict</li>
            <li>Data hasn't been collected yet (run <code>ticker-cli run-all</code>)</li>
          </ul>
        </div>
        {{ end }}
      </div>
      
      <!-- Strategy Navigation -->
      <div class="card mb-5">
        <div class="card-header">
          <h5 class="mb-0">Explore Other Strategies</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <a href="/strategy-dividend-daddy/" class="btn btn-outline-primary w-100">
                üí∞ Dividend Daddy
              </a>
            </div>
            <div class="col-md-4">
              <a href="/strategy-moon-shot/" class="btn btn-outline-primary w-100">
                üöÄ Moon Shot
              </a>
            </div>
            <div class="col-md-4">
              <a href="/strategy-falling-knife/" class="btn btn-outline-primary w-100">
                üî™ Falling Knife
              </a>
            </div>
            <div class="col-md-4">
              <a href="/strategy-over-hyped/" class="btn btn-outline-primary w-100">
                üìà Over Hyped
              </a>
            </div>
            <div class="col-md-4">
              <a href="/strategy-institutional-whale/" class="btn btn-outline-primary w-100">
                üêã Institutional Whale
              </a>
            </div>
            <div class="col-md-4">
              <a href="/filtered-data/" class="btn btn-outline-secondary w-100">
                üìä All Filtered Data
              </a>
            </div>
          </div>
        </div>
      </div>
      
      {{ else }}
      
      <!-- No Data Alert -->
      <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">No Data Available</h4>
        <p>Strategy filter data has not been generated yet. Run the following commands:</p>
        <pre><code>ticker-cli run-all
ticker-cli hugo strategies
ticker-cli hugo pages</code></pre>
      </div>
      
      {{ end }}
    </div>
  </div>
</div>

<!-- DataTables for sorting and filtering - CSS only here -->
{{ if gt $strategyData.total_matches 0 }}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
{{ end }}
{{ end }}
{{ define "page-scripts" }}
{{ $strategyData := index .Site.Data (printf "strategy_%s" .Params.strategy_key) }}
{{ if gt $strategyData.total_matches 0 }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
  if ($('#strategyTable').length) {
    // Find the last column index (Strategy Score column)
    const lastColIndex = $('#strategyTable thead tr th').length - 1;
    
    // All numeric columns (everything after Exchange)
    const numericCols = [];
    for (let i = 3; i <= lastColIndex; i++) {
      numericCols.push({ targets: i, type: 'num' });
    }
    
    $('#strategyTable').DataTable({
      pageLength: 25,
      order: [[lastColIndex, 'desc']], // Sort by strategy score descending
      columnDefs: numericCols
    });
  }
});
</script>
{{ end }}
{{ end }}
